(function(i,l){typeof exports=="object"&&typeof module<"u"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(i=typeof globalThis<"u"?globalThis:i||self,l(i.RevocableModule={}))})(this,function(i){"use strict";var k=Object.defineProperty;var P=(i,l,c)=>l in i?k(i,l,{enumerable:!0,configurable:!0,writable:!0,value:c}):i[l]=c;var p=(i,l,c)=>(P(i,typeof l!="symbol"?l+"":l,c),c);function l(n){return Object.prototype.toString.call(n)==="[object Object]"}function c(n){return typeof n=="object"}function b(n,t){return Object.hasOwn?Object.hasOwn(n,t):Object.prototype.hasOwnProperty.call(n,t)}class u{constructor(t,e,a,s){p(this,"op");p(this,"propName");p(this,"returnOp");p(this,"returnVal");p(this,"snapTag");this.op=t,this.propName=e,this.returnOp=this.getReturnOp(),this.snapTag=s,t!=="add"&&(this.returnVal=a)}getReturnOp(){return{add:"deleteProperty",set:"set",deleteProperty:"add"}[this.op]}}const h=class{constructor(t,e){p(this,"opStack",[]);p(this,"stepBackup",[]);p(this,"target");p(this,"snapable");this.target=t,this.snapable=e.snapable;let a=this;a.opStack.push=function(...s){return a.stepBackup=[],Array.prototype.push.call(this,...s)}}static clearVisitPath(){h.currRootHelperInstance=null,this.visitingPath=[]}_getRootHelperInstance(){return h.currRootHelperInstance||this}_deepGetValue(t){let e=this.target,a=0;for(;a<t.length;)e=e[t[a]],a++;return e}_getFullPropPath(t){return h.visitingPath.concat(t)}_backByPath(t){let e=[...t.propName],a=e.pop(),s=t.returnOp==="add"?"set":t.returnOp,r=this._getRootHelperInstance().target,o=0;for(;o<e.length;)r=r[e[o]],o++;Reflect[s](r,a,t.returnVal)}_rememberStep(t){this._getRootHelperInstance().opStack.push(t)}snap(){if(!this.opStack.length)return;let t=this.opStack.length;this.opStack[t-1].snapTag=!0}rollbackToSnapshot(){let t=this.opStack[this.opStack.length-1];for(t&&t.snapTag&&(this.rollback(),t=this.opStack[this.opStack.length-1]);t&&!t.snapTag;)this.rollback(),t=this.opStack[this.opStack.length-1]}cancelRollbackToSnapshot(){let t=this.stepBackup[this.stepBackup.length-1];for(;t&&(this.cancelRollback(),!t.snapTag);)t=this.stepBackup[this.stepBackup.length-1]}rollback(){let t=this.opStack.pop();if(!t)return;let e=new u(t.returnOp,t.propName,this._deepGetValue(t.propName),t.snapTag);this.stepBackup.push(e),this._backByPath(t)}cancelRollback(){let t=this.stepBackup.pop();if(!t)return;let e=new u(t.returnOp,t.propName,this._deepGetValue(t.propName),t.snapTag);Array.prototype.push.call(this.opStack,e),this._backByPath(t)}get(t,e){if(e==="_snapshot")return this.snap.bind(this);if(e==="_rollback")return this.snapable?this.rollbackToSnapshot.bind(this):this.rollback.bind(this);if(e==="_cancelRollback")return this.snapable?this.cancelRollbackToSnapshot.bind(this):this.cancelRollback.bind(this);h.visitingPath.length===0&&(h.currRootHelperInstance=this),h.visitingPath.push(e);let a=Reflect.get(t,e);return c(a)?f(a):(h.clearVisitPath(),a)}set(t,e,a){let s,r;if(b(t,e)){let o=Reflect.get(t,e);s=Reflect.set(t,e,a),r=new u("set",this._getFullPropPath(e),o)}else s=Reflect.set(t,e,a),r=new u("add",this._getFullPropPath(e));return this._rememberStep(r),h.clearVisitPath(),s}deleteProp(t,e){if(Reflect.has(t,e)){let a=Reflect.get(t,e),s=new u("deleteProperty",this._getFullPropPath(e),a);this._rememberStep(s)}return h.clearVisitPath(),Reflect.deleteProperty(t,e)}};let g=h;p(g,"currRootHelperInstance"),p(g,"visitingPath",[]);function d(n){return l(n)?n:{snapable:!!n}}function f(n,t=!1){let e=new g(n,d(t));return new Proxy(n,{get(s,r){return e.get(s,r)},set(s,r,o){return e.set(s,r,o)},deleteProperty(s,r){return e.deleteProp(s,r)}})}i.Revocable=f,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});
