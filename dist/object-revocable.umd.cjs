(function(r,s){typeof exports=="object"&&typeof module<"u"?s(exports):typeof define=="function"&&define.amd?define(["exports"],s):(r=typeof globalThis<"u"?globalThis:r||self,s(r.RevocableModule={}))})(this,function(r){"use strict";var g=Object.defineProperty;var P=(r,s,a)=>s in r?g(r,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[s]=a;var c=(r,s,a)=>(P(r,typeof s!="symbol"?s+"":s,a),a);function s(d){return typeof d=="object"}var a=a||{};class p{constructor(e,t,l){c(this,"op");c(this,"propName");c(this,"returnOp");c(this,"returnVal");this.op=e,this.propName=t,this.returnOp=this.getReturnOp(),e!=="add"&&(this.returnVal=l)}getReturnOp(){return{add:"deleteProperty",set:"set",deleteProperty:"add"}[this.op]}}const i=class{constructor(e){c(this,"opStack",[]);c(this,"stepBackup",[]);c(this,"target");a.dd=()=>{a.ss1=this.opStack,a.ss2=this.stepBackup,console.log(this.opStack,this.stepBackup)},this.target=e;let t=this;t.opStack.push=function(...l){return t.stepBackup=[],Array.prototype.push.call(this,...l)}}static clearVisitPath(){i.currRootHelperInstance=null,this.visitingPath=[]}_getRootHelperInstance(){return i.currRootHelperInstance||this}_deepGetValue(e){let t=this.target,l=0;for(;l<e.length;)t=t[e[l]],l++;return t}_getFullPropPath(e){return i.visitingPath.concat(e)}_backByPath(e){let t=[...e.propName],l=t.pop(),n=e.returnOp==="add"?"set":e.returnOp,o=this._getRootHelperInstance().target,u=0;for(;u<t.length;)console.log(o[t[u]]),o=o[t[u]],u++;Reflect[n](o,l,e.returnVal)}_rememberStep(e){this._getRootHelperInstance().opStack.push(e)}rollback(){let e=this.opStack.pop();if(!e)return;let t=new p(e.returnOp,e.propName,this._deepGetValue(e.propName));this.stepBackup.push(t),this._backByPath(e)}cancelRollback(){let e=this.stepBackup.pop();if(!e)return;let t=new p(e.returnOp,e.propName,this._deepGetValue(e.propName));Array.prototype.push.call(this.opStack,t),this._backByPath(e)}get(e,t){if(console.log("get"),t==="_rollback")return this.rollback.bind(this);if(t==="_cancelRollback")return this.cancelRollback.bind(this);i.visitingPath.length===0&&(i.currRootHelperInstance=this),i.visitingPath.push(t);let l=Reflect.get(e,t);return s(l)?f(l):(i.clearVisitPath(),l)}set(e,t,l){console.log("set"),console.log(i.visitingPath,"in set");let n,o;if(Reflect.has(e,t)){let u=Reflect.get(e,t);n=Reflect.set(e,t,l),o=new p("set",this._getFullPropPath(t),u)}else n=Reflect.set(e,t,l),o=new p("add",this._getFullPropPath(t));return this._rememberStep(o),i.clearVisitPath(),n}deleteProp(e,t){if(console.log("deleteProp",Reflect.has(e,t)),Reflect.has(e,t)){let l=Reflect.get(e,t),n=new p("deleteProperty",this._getFullPropPath(t),l);this._rememberStep(n)}return i.clearVisitPath(),Reflect.deleteProperty(e,t)}};let h=i;c(h,"currRootHelperInstance"),c(h,"visitingPath",[]),a.RevocableHelper=h;function f(d){let e=new h(d);return console.log(e),new Proxy(d,{get(l,n){return e.get(l,n)},set(l,n,o){return e.set(l,n,o)},deleteProperty(l,n){return e.deleteProp(l,n)}})}r.OpInfo=p,r.Revocable=f,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
