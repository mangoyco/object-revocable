(function(n,i){typeof exports=="object"&&typeof module<"u"?i(exports):typeof define=="function"&&define.amd?define(["exports"],i):(n=typeof globalThis<"u"?globalThis:n||self,i(n.RevocableModule={}))})(this,function(n){"use strict";var b=Object.defineProperty;var P=(n,i,h)=>i in n?b(n,i,{enumerable:!0,configurable:!0,writable:!0,value:h}):n[i]=h;var r=(n,i,h)=>(P(n,typeof i!="symbol"?i+"":i,h),h);function i(p){return Object.prototype.toString.call(p)==="[object Object]"}function h(p){return typeof p=="object"}var f=f||{};class u{constructor(t,e,s,a){r(this,"op");r(this,"propName");r(this,"returnOp");r(this,"returnVal");r(this,"snapTag");this.op=t,this.propName=e,this.returnOp=this.getReturnOp(),this.snapTag=a,t!=="add"&&(this.returnVal=s)}getReturnOp(){return{add:"deleteProperty",set:"set",deleteProperty:"add"}[this.op]}}const c=class{constructor(t,e){r(this,"opStack",[]);r(this,"stepBackup",[]);r(this,"target");r(this,"snapable");f.dd=()=>{f.ss1=this.opStack,f.ss2=this.stepBackup,console.log(this.opStack,this.stepBackup)},this.target=t,this.snapable=e.snapable;let s=this;s.opStack.push=function(...a){return s.stepBackup=[],Array.prototype.push.call(this,...a)}}static clearVisitPath(){c.currRootHelperInstance=null,this.visitingPath=[]}_getRootHelperInstance(){return c.currRootHelperInstance||this}_deepGetValue(t){let e=this.target,s=0;for(;s<t.length;)e=e[t[s]],s++;return e}_getFullPropPath(t){return c.visitingPath.concat(t)}_backByPath(t){let e=[...t.propName],s=e.pop(),a=t.returnOp==="add"?"set":t.returnOp,l=this._getRootHelperInstance().target,o=0;for(;o<e.length;)console.log(l[e[o]]),l=l[e[o]],o++;Reflect[a](l,s,t.returnVal)}_rememberStep(t){this._getRootHelperInstance().opStack.push(t)}snap(){if(!this.opStack.length)return;let t=this.opStack.length;this.opStack[t-1].snapTag=!0}rollbackToSnapshot(t=!0){let e=this.opStack[this.opStack.length-1];for(e&&e.snapTag&&(this.rollback(),e=this.opStack[this.opStack.length-1]);e&&!e.snapTag;)this.rollback(),e=this.opStack[this.opStack.length-1]}cancelRollbackToSnapshot(){let t=this.stepBackup[this.stepBackup.length-1];for(;t&&(this.cancelRollback(),!t.snapTag);)t=this.stepBackup[this.stepBackup.length-1]}rollback(){let t=this.opStack.pop();if(!t)return;let e=new u(t.returnOp,t.propName,this._deepGetValue(t.propName),t.snapTag);this.stepBackup.push(e),this._backByPath(t)}cancelRollback(){let t=this.stepBackup.pop();if(!t)return;let e=new u(t.returnOp,t.propName,this._deepGetValue(t.propName),t.snapTag);Array.prototype.push.call(this.opStack,e),this._backByPath(t)}get(t,e){if(console.log("get",e),e==="_snapshot")return this.snap.bind(this);if(e==="_rollback")return this.snapable?this.rollbackToSnapshot.bind(this):this.rollback.bind(this);if(e==="_cancelRollback")return this.snapable?this.cancelRollbackToSnapshot.bind(this):this.cancelRollback.bind(this);c.visitingPath.length===0&&(c.currRootHelperInstance=this),c.visitingPath.push(e);let s=Reflect.get(t,e);return h(s)?k(s):(c.clearVisitPath(),s)}set(t,e,s){let a,l;if(Reflect.has(t,e)){let o=Reflect.get(t,e);a=Reflect.set(t,e,s),l=new u("set",this._getFullPropPath(e),o)}else a=Reflect.set(t,e,s),l=new u("add",this._getFullPropPath(e));return this._rememberStep(l),c.clearVisitPath(),a}deleteProp(t,e){if(console.log("deleteProp",Reflect.has(t,e)),Reflect.has(t,e)){let s=Reflect.get(t,e),a=new u("deleteProperty",this._getFullPropPath(e),s);this._rememberStep(a)}return c.clearVisitPath(),Reflect.deleteProperty(t,e)}};let g=c;r(g,"currRootHelperInstance"),r(g,"visitingPath",[]),f.RevocableHelper=g;function d(p){return i(p)?p:{snapable:!!p}}function k(p,t=!1){let e=new g(p,d(t));return console.log(e),new Proxy(p,{get(a,l){return e.get(a,l)},set(a,l,o){return e.set(a,l,o)},deleteProperty(a,l){return e.deleteProp(a,l)}})}n.OpInfo=u,n.Revocable=k,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
