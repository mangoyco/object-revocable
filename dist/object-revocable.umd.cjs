(function(r,l){typeof exports=="object"&&typeof module<"u"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(r=typeof globalThis<"u"?globalThis:r||self,l(r.RevocableModule={}))})(this,function(r){"use strict";var k=Object.defineProperty;var b=(r,l,c)=>l in r?k(r,l,{enumerable:!0,configurable:!0,writable:!0,value:c}):r[l]=c;var i=(r,l,c)=>(b(r,typeof l!="symbol"?l+"":l,c),c);function l(h){return Object.prototype.toString.call(h)==="[object Object]"}function c(h){return typeof h=="object"}class u{constructor(t,e,a,s){i(this,"op");i(this,"propName");i(this,"returnOp");i(this,"returnVal");i(this,"snapTag");this.op=t,this.propName=e,this.returnOp=this.getReturnOp(),this.snapTag=s,t!=="add"&&(this.returnVal=a)}getReturnOp(){return{add:"deleteProperty",set:"set",deleteProperty:"add"}[this.op]}}const p=class{constructor(t,e){i(this,"opStack",[]);i(this,"stepBackup",[]);i(this,"target");i(this,"snapable");this.target=t,this.snapable=e.snapable;let a=this;a.opStack.push=function(...s){return a.stepBackup=[],Array.prototype.push.call(this,...s)}}static clearVisitPath(){p.currRootHelperInstance=null,this.visitingPath=[]}_getRootHelperInstance(){return p.currRootHelperInstance||this}_deepGetValue(t){let e=this.target,a=0;for(;a<t.length;)e=e[t[a]],a++;return e}_getFullPropPath(t){return p.visitingPath.concat(t)}_backByPath(t){let e=[...t.propName],a=e.pop(),s=t.returnOp==="add"?"set":t.returnOp,n=this._getRootHelperInstance().target,o=0;for(;o<e.length;)n=n[e[o]],o++;Reflect[s](n,a,t.returnVal)}_rememberStep(t){this._getRootHelperInstance().opStack.push(t)}snap(){if(!this.opStack.length)return;let t=this.opStack.length;this.opStack[t-1].snapTag=!0}rollbackToSnapshot(){let t=this.opStack[this.opStack.length-1];for(t&&t.snapTag&&(this.rollback(),t=this.opStack[this.opStack.length-1]);t&&!t.snapTag;)this.rollback(),t=this.opStack[this.opStack.length-1]}cancelRollbackToSnapshot(){let t=this.stepBackup[this.stepBackup.length-1];for(;t&&(this.cancelRollback(),!t.snapTag);)t=this.stepBackup[this.stepBackup.length-1]}rollback(){let t=this.opStack.pop();if(!t)return;let e=new u(t.returnOp,t.propName,this._deepGetValue(t.propName),t.snapTag);this.stepBackup.push(e),this._backByPath(t)}cancelRollback(){let t=this.stepBackup.pop();if(!t)return;let e=new u(t.returnOp,t.propName,this._deepGetValue(t.propName),t.snapTag);Array.prototype.push.call(this.opStack,e),this._backByPath(t)}get(t,e){if(e==="_snapshot")return this.snap.bind(this);if(e==="_rollback")return this.snapable?this.rollbackToSnapshot.bind(this):this.rollback.bind(this);if(e==="_cancelRollback")return this.snapable?this.cancelRollbackToSnapshot.bind(this):this.cancelRollback.bind(this);p.visitingPath.length===0&&(p.currRootHelperInstance=this),p.visitingPath.push(e);let a=Reflect.get(t,e);return c(a)?f(a):(p.clearVisitPath(),a)}set(t,e,a){let s,n;if(Reflect.has(t,e)){let o=Reflect.get(t,e);s=Reflect.set(t,e,a),n=new u("set",this._getFullPropPath(e),o)}else s=Reflect.set(t,e,a),n=new u("add",this._getFullPropPath(e));return this._rememberStep(n),p.clearVisitPath(),s}deleteProp(t,e){if(Reflect.has(t,e)){let a=Reflect.get(t,e),s=new u("deleteProperty",this._getFullPropPath(e),a);this._rememberStep(s)}return p.clearVisitPath(),Reflect.deleteProperty(t,e)}};let g=p;i(g,"currRootHelperInstance"),i(g,"visitingPath",[]);function d(h){return l(h)?h:{snapable:!!h}}function f(h,t=!1){let e=new g(h,d(t));return new Proxy(h,{get(s,n){return e.get(s,n)},set(s,n,o){return e.set(s,n,o)},deleteProperty(s,n){return e.deleteProp(s,n)}})}r.Revocable=f,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
