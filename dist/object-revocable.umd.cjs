(function(r,s){typeof exports=="object"&&typeof module<"u"?s(exports):typeof define=="function"&&define.amd?define(["exports"],s):(r=typeof globalThis<"u"?globalThis:r||self,s(r.RevocableModule={}))})(this,function(r){"use strict";var f=Object.defineProperty;var g=(r,s,i)=>s in r?f(r,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[s]=i;var c=(r,s,i)=>(g(r,typeof s!="symbol"?s+"":s,i),i);function s(u){return typeof u=="object"}class i{constructor(e,t,l){c(this,"op");c(this,"propName");c(this,"returnOp");c(this,"returnVal");this.op=e,this.propName=t,this.returnOp=this.getReturnOp(),e!=="add"&&(this.returnVal=l)}getReturnOp(){return{add:"deleteProperty",set:"set",deleteProperty:"add"}[this.op]}}const a=class{constructor(e){c(this,"opStack",[]);c(this,"stepBackup",[]);c(this,"target");window.dd=()=>{window.ss1=this.opStack,window.ss2=this.stepBackup,console.log(this.opStack,this.stepBackup)},this.target=e;let t=this;t.opStack.push=function(...l){return t.stepBackup=[],Array.prototype.push.call(this,...l)}}static clearVisitPath(){a.currRootHelperInstance=null,this.visitingPath=[]}_getRootHelperInstance(){return a.currRootHelperInstance||this}_deepGetValue(e){let t=this.target,l=0;for(;l<e.length;)console.log(t[e[l]]),t=t[e[l]],l++;return t}_getFullPropPath(e){return a.visitingPath.concat(e)}_backByPath(e){let t=[...e.propName],l=t.pop(),n=e.returnOp==="add"?"set":e.returnOp,o=this._getRootHelperInstance().target,h=0;for(;h<t.length;)console.log(o[t[h]]),o=o[t[h]],h++;Reflect[n](o,l,e.returnVal)}_rememberStep(e){this._getRootHelperInstance().opStack.push(e)}rollback(){let e=this.opStack.pop();if(!e)return;let t=new i(e.returnOp,e.propName,this._deepGetValue(e.propName));this.stepBackup.push(t),this._backByPath(e)}cancelRollback(){let e=this.stepBackup.pop();if(!e)return;let t=new i(e.returnOp,e.propName,this._deepGetValue(e.propName));Array.prototype.push.call(this.opStack,t),this._backByPath(e)}get(e,t){if(a.visitingPath.length===0&&(a.currRootHelperInstance=this),a.visitingPath.push(t),t==="_rollback")return this.rollback.bind(this);if(t==="_cancelRollback")return this.cancelRollback.bind(this);let l=Reflect.get(e,t);return s(l)?d(l):(a.clearVisitPath(),l)}set(e,t,l){console.log("set"),console.log(a.visitingPath,"in set");let n,o;if(Reflect.has(e,t)){let h=Reflect.get(e,t);n=Reflect.set(e,t,l),o=new i("set",this._getFullPropPath(t),h)}else n=Reflect.set(e,t,l),o=new i("add",this._getFullPropPath(t));return this._rememberStep(o),n}deleteProp(e,t){if(console.log("deleteProp",Reflect.has(e,t)),Reflect.has(e,t)){let l=Reflect.get(e,t),n=new i("deleteProperty",this._getFullPropPath(t),l);this._rememberStep(n)}return Reflect.deleteProperty(e,t)}};let p=a;c(p,"currRootHelperInstance"),c(p,"visitingPath",[]),window.RevocableHelper=p;function d(u){let e=new p(u);return console.log(e),new Proxy(u,{get(l,n){return e.get(l,n)},set(l,n,o){return e.set(l,n,o)},deleteProperty(l,n){return e.deleteProp(l,n)}})}r.OpInfo=i,r.Revocable=d,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
